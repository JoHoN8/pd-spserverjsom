!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("jquery"),require("pd-sputil")):"function"==typeof define&&define.amd?define(["jquery","pd-sputil"],t):"object"==typeof exports?exports.pdspserverjsom=t(require("jquery"),require("pd-sputil")):e.pdspserverjsom=t(e.$,e.pdsputil)}(this,function(e,t){return function(e){function t(r){if(n[r])return n[r].exports;var o=n[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var n={};return t.m=e,t.c=n,t.i=function(e){return e},t.d=function(e,n,r){t.o(e,n)||Object.defineProperty(e,n,{configurable:!1,enumerable:!0,get:r})},t.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(n,"a",n),n},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=2)}([function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t,n){"use strict";function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e){return n.i(m.waitForScriptsReady)("sp.js").then(function(){return y(e)})}function i(e){return n.i(m.waitForScriptsReady)("SP.js").then(function(){var t,n,r,o=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,i=new SP.CamlQuery;return r=e.listGUID?o.get_web().get_lists().getById(e.listGUID):o.get_web().get_lists().getById(e.listTitle),e.position&&(t=new SP.ListItemCollectionPosition,t.set_pagingInfo(e.position),i.set_listItemCollectionPosition(t)),e.folderRelativeUrl&&i.set_folderServerRelativeUrl(e.folderRelativeUrl),i.set_viewXml(e.query),n=r.getItems(i),e.columnsToInclude?o.load(n,"Include("+e.columnsToInclude.join(",")+")"):o.load(n),c({context:o,listItems:n})})}function a(e,t){var r,o,i,a,l,s=n.i(m.getDataType)(t),u=/^i:0#\.f\|membership\|/,f=[],p=d.Deferred();if("object"===s&&(r=[t]),"array"===s&&(r=t),!r)throw new Error("an object or array must be the parameter to jsomEnsureUser");return o=e?new SP.ClientContext(e):new SP.ClientContext.get_current,a=o.get_web(),r.forEach(function(e,t){i=e.AccountName||e.WorkEmail,u.test(i)||(e.AccountName="i:0#.f|membership|"+i.toLowerCase(),i=e.AccountName),l=a.ensureUser(i),f[t]=l,o.load(f[t])}),c({context:o}).then(function(){var e,t;r.forEach(function(e,n){t=f[n],e.id=t.get_id(),e.WorkEmail||(e.WorkEmail=t.get_email()),e.PreferredName||(e.PreferredName=t.get_title())}),e="[object Object]"===s?r[0]:r,p.resolve(e)}).fail(function(){p.reject()}),p.promise()}function l(e){return n.i(m.waitForScriptsReady)("SP.js").then(function(){var t,n=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,r=e.allResults||[],o=e.maxPerTrip||100,i=e.arrayOfIds.length,a=e.numberToStartAt||0,s=[];for(t=e.listGUID?n.get_web().get_lists().getById(e.listGUID):n.get_web().get_lists().getByTitle(e.listTitle);a<i;){var u=t.getItemById(e.arrayOfIds[a]);if(e.columnsToInclude?n.load(u,e.columnsToInclude):n.load(u),s.push(u),s.length===o){a++;break}a++}return c({context:n,listItems:s}).then(function(t){var n=p(t.listItems);return e.allResults=r.concat(n),a<i?(e.numberToStartAt=a,l(e)):e.allResults})})}function s(e){return n.i(m.waitForScriptsReady)("SP.js").then(function(){for(var t=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,n=t.get_web(),r=e.fileRefs.length,o=0,i=[];o<r;){var a=n.getFileByServerRelativeUrl(e.fileRefs[o]);e.columnsToInclude?t.load(a,e.columnsToInclude):t.load(a),i.push(a),o++}return c({context:t,files:i}).then(function(e){return e})})}function u(e,t){return n.i(m.waitForScriptsReady)("sp.js").then(function(){return SP.Taxonomy?d.Deferred().resolve():n.i(m.loadSPScript)("sp.taxonomy.js")}).then(function(){var n=new SP.ClientContext.get_current,r=SP.Taxonomy.TaxonomySession.getTaxonomySession(n),o=r.get_termStores().getById(e),i=o.getTermSet(t),a=i.getAllTerms();return n.load(a,"Include(CustomProperties, Id,IsAvailableForTagging, LocalCustomProperties, Name, PathOfTerm)"),c({context:n,terms:a})})}function c(e){var t=d.Deferred();return e.context.executeQueryAsync(function(){t.resolve(e)},function(){t.reject(arguments)}),t.promise()}Object.defineProperty(t,"__esModule",{value:!0}),t.jsomGetDataFromSearch=o,t.jsomListItemRequest=i,t.jsomEnsureUser=a,t.jsomGetItemsById=l,t.jsomGetFilesByRelativeUrl=s,t.jsomTaxonomyRequest=u,t.jsomSendDataToServer=c,n.d(t,"jsomCUD",function(){return h});var d=n(0),m=(n.n(d),n(1)),f=(n.n(m),function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}()),p=function(e){var t,n=[];if(t=e.context?e.listItems:e,t.getEnumerator){for(var r=t.getEnumerator();r.moveNext();)n.push(r.get_current().get_fieldValues());return n}return t.forEach(function(e){n.push(e.get_fieldValues())}),n},y=function e(t){var r=null,o=t.allResults||[],i=Microsoft.SharePoint.Client;return r=i&&i.Search?d.Deferred().resolve():n.i(m.loadSPScript)("SP.Search.js"),r.then(function(){var e=t.url?new SP.ClientContext(t.url):new SP.ClientContext("/search"),n=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(e);if(t.startRow||(t.startRow=0),t.rowLimit||(t.rowLimit=250),n.set_queryText(t.query),n.set_sourceId(t.sourceId),n.set_trimDuplicates(t.trimDuplicates||!1),n.set_startRow(t.startRow),n.set_rowLimit(t.rowLimit),t.properties){var r=n.get_selectProperties();t.properties.forEach(function(e){r.add(e)})}return c({context:e,results:new Microsoft.SharePoint.Client.Search.Query.SearchExecutor(e).executeQuery(n)})}).then(function(n){var r=n.results.get_value(),i=r.ResultTables[0],a=i.ResultRows;return 0===a.length?t.allResults=[]:t.allResults=o.concat(a),i.TotalRows>t.startRow+i.RowCount?(t.startRow=t.startRow+i.RowCount,e(t)):t.allResults})},h=function(){function e(){r(this,e),this.itemsToSend=[],this.userRequests=[]}return f(e,[{key:"_getContext",value:function(e){return this.context=e?new this.sp.ClientContext(e):new this.sp.ClientContext.get_current,this}},{key:"_getList",value:function(e){var t=n.i(m.validGuid)(e);return this.list=t?this.context.get_web().get_lists().getById(e):this.context.get_web().get_lists().getByTitle(e),this}},{key:"_dataTranmitter",value:function(){return c({context:this.context,listItems:this.itemsToSend})}},{key:"_addColumnData",value:function(e,t){var n=this;return t.forEach(function(t){if("taxBlank"===t.dataType){var r=n.list.get_fields().getByInternalNameOrTitle(t.columnName);n.context.castTo(r,n.sp.Taxonomy.TaxonomyField).validateSetValue(e,null)}else if("taxSingle"===t.dataType){var o=n.list.get_fields().getByInternalNameOrTitle(t.columnName),i=n.context.castTo(o,n.sp.Taxonomy.TaxonomyField),a=new n.sp.Taxonomy.TaxonomyFieldValue;a.set_label(t.termLabel),a.set_termGuid(t.termGuid),a.set_wssId(-1),i.setFieldValueByValue(e,a)}else if("taxMulti"===t.dataType){var l=n.list.get_fields().getByInternalNameOrTitle(t.columnName),s=n.context.castTo(l,n.sp.Taxonomy.TaxonomyField),u=t.multiTerms.map(function(e){return"-1;# "+e.termLabel+"|"+e.termGuid}),c=n.sp.Taxonomy.TaxonomyFieldValueCollection(u.join(";#"),s);s.setFieldValueByValueCollection(e,c)}else if("choiceMulti"===t.dataType)e.set_item(t.columnName,t.choices);else if("lookupSingle"===t.dataType){var d=new n.sp.FieldLookupValue;d.set_lookupId(t.itemId),e.set_item(t.columnName,d)}else if("lookupMulti"===t.dataType){var m=t.idArray.map(function(e){return n.sp.FieldUserValue.fromUser(e)});e.set_item(t.columnName,m)}else if("ppSingle"===t.dataType){var f=n.sp.FieldUserValue.fromUser(t.account);e.set_item(t.columnName,f)}else if("ppMulti"===t.dataType){var p=t.accountArray.map(function(e){return(new n.sp.FieldLookupValue).set_lookupId(e)});e.set_item(t.columnName,p)}else if("hyperlink"===t.dataType){var y=new n.sp.FieldUrlValue;y.set_url(t.url),y.set_description(t.description),e.set_item(t.columnName,y)}else"simple"===t.dataType&&e.set_item(t.columnName,t.columnValue)},this),this}},{key:"_loadItem",value:function(e){var t=this.itemsToSend.length;return e.update(),this.itemsToSend[t]=e,this.context.load(this.itemsToSend[t]),this}},{key:"_createListItems",value:function(){var e=this;return this.userRequests.forEach(function(t){var n=null;"create"===t.action?(n=e.list.addItem(new e.sp.ListItemCreationInformation),e._addColumnData(n,t.columnData)._loadItem(n)):"update"===t.action?(n=e.list.getItemById(t.itemId),e._addColumnData(n,t.columnData)._loadItem(n)):"recycle"===t.action?(n=e.list.getItemById(t.itemId),n.recycle()):"delete"===t.action&&(n=e.list.getItemById(t.itemId),n.deleteObject())},this),this}},{key:"_determineDataType",value:function(e){null===e.termGuid?e.dataType="taxBlank":e.termGuid?e.dataType="taxSingle":e.multiTerms?e.dataType="taxMulti":e.choices?e.dataType="choiceMulti":e.itemId?e.dataType="lookupSingle":e.idArray?e.dataType="lookupMulti":e.account?e.dataType="ppSingle":e.accountArray?e.dataType="ppMulti":e.url?e.dataType="hyperlink":e.dataType="simple"}},{key:"_addDataType",value:function(e){var t=this,n=[];return e.forEach(function(e){var r=Object.assign({},e);t._determineDataType(r),n.push(r)}),n}},{key:"_addItem",value:function(e,t,n){var r={};if(!e)throw new Error("action must be provided to add an object to addItem function");if(r.action=e.toLowerCase(),"create"!==e&&!n)throw new Error("a item id must be provided to update, delete or recycle an item");r.itemId=n,"create"!==e&&"update"!==e||(r.columnData=this._addDataType(t)),this.userRequests.push(r)}},{key:"createItem",value:function(e){this._addItem("create",e)}},{key:"updateItem",value:function(e,t){this._addItem("update",t,e)}},{key:"recycleItem",value:function(e){var t=this,r=n.i(m.getDataType)(e);if("number"===r)this._addItem("recycle",null,e);else{if("array"!==r)throw new Error("invalid datatype passed to recycle item function");e.forEach(function(e){t._addItem("recycle",null,e)},this)}}},{key:"deleteItem",value:function(e){var t=this,r=n.i(m.getDataType)(e);if("number"===r)this._addItem("delete",null,e);else{if("array"!==r)throw new Error("invalid datatype passed to delete item function");e.forEach(function(e){t._addItem("delete",null,e)},this)}}},{key:"sendToSever",value:function(e,t){var r=d.Deferred(),o=this;return n.i(m.waitForScriptsReady)("sp.js").then(function(){return o.sp=SP,o._getContext(e)._getList(t)._createListItems(),o._dataTranmitter()}).then(function(e){r.resolve(e)}).fail(function(e){r.reject(e)}),r.promise()}}]),e}()}])});