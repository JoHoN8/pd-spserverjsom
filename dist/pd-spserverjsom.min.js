!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("pd-sputil")):"function"==typeof define&&define.amd?define(["pd-sputil"],t):"object"==typeof exports?exports.pdspserverjsom=t(require("pd-sputil")):e.pdspserverjsom=t(e.pdsputil)}(this,function(e){return function(e){function t(n){if(r[n])return r[n].exports;var o=r[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};return t.m=e,t.c=r,t.d=function(e,r,n){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:n})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=0)}([function(e,t,r){"use strict";function n(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e){return Object(p.waitForScriptsReady)("sp.js").then(function(){return y(e)})}function s(e){return Object(p.waitForScriptsReady)("SP.js").then(function(){var t,r,n,o=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,a=new SP.CamlQuery;return n=e.listGUID?o.get_web().get_lists().getById(e.listGUID):o.get_web().get_lists().getById(e.listTitle),e.position&&(t=new SP.ListItemCollectionPosition,t.set_pagingInfo(e.position),a.set_listItemCollectionPosition(t)),e.folderRelativeUrl&&a.set_folderServerRelativeUrl(e.folderRelativeUrl),a.set_viewXml(e.query),r=n.getItems(a),e.columnsToInclude?o.load(r,"Include("+e.columnsToInclude.join(",")+")"):o.load(r),d({context:o,listItems:r})})}function l(e,t){var r,n,o,a,i,s=Object(p.getDataType)(t),l=/^i:0#\.f\|membership\|/,u=[];if("object"===s&&(r=[t]),"array"===s&&(r=t),!r)throw new Error("an object or array must be the parameter to jsomEnsureUser");return n=e?new SP.ClientContext(e):new SP.ClientContext.get_current,a=n.get_web(),r.forEach(function(e,t){o=e.AccountName||e.WorkEmail,l.test(o)||(e.AccountName="i:0#.f|membership|"+o.toLowerCase(),o=e.AccountName),i=a.ensureUser(o),u[t]=i,n.load(u[t])}),d({context:n}).then(function(){var e;return r.forEach(function(t,r){e=u[r],t.id=e.get_id(),t.WorkEmail||(t.WorkEmail=e.get_email()),t.PreferredName||(t.PreferredName=e.get_title())}),"[object Object]"===s?r[0]:r})}function u(e){return Object(p.waitForScriptsReady)("SP.js").then(function(){var t,r=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,n=e.allResults||[],o=e.maxPerTrip||100,a=e.arrayOfIds.length,i=e.numberToStartAt||0,s=[];for(t=e.listGUID?r.get_web().get_lists().getById(e.listGUID):r.get_web().get_lists().getByTitle(e.listTitle);i<a;){var l=t.getItemById(e.arrayOfIds[i]);if(e.columnsToInclude?r.load(l,e.columnsToInclude):r.load(l),s.push(l),s.length===o){i++;break}i++}return d({context:r,listItems:s}).then(function(t){var r=h(t.listItems);return e.allResults=n.concat(r),i<a?(e.numberToStartAt=i,u(e)):e.allResults})})}function c(e){return Object(p.waitForScriptsReady)("SP.js").then(function(){for(var t=e.url?new SP.ClientContext(e.url):new SP.ClientContext.get_current,r=t.get_web(),n=e.fileRefs.length,o=0,a=[];o<n;){var i=r.getFileByServerRelativeUrl(e.fileRefs[o]);e.columnsToInclude?t.load(i,e.columnsToInclude):t.load(i),a.push(i),o++}return d({context:t,files:a}).then(function(e){return e})})}function m(e,t){return Object(p.waitForScriptsReady)("sp.js").then(function(){return SP.Taxonomy?Promise.resolve():Object(p.loadSPScript)("sp.taxonomy.js")}).then(function(){var r=new SP.ClientContext.get_current,n=SP.Taxonomy.TaxonomySession.getTaxonomySession(r),o=n.get_termStores().getById(e),a=o.getTermSet(t),i=a.getAllTerms();return r.load(i,"Include(CustomProperties, Id,IsAvailableForTagging, LocalCustomProperties, Name, PathOfTerm)"),d({context:r,terms:i})})}function d(e){return new Promise(function(t,r){e.context.executeQueryAsync(function(){t(e)},function(){r(arguments)})})}Object.defineProperty(t,"__esModule",{value:!0}),t.jsomGetDataFromSearch=i,t.jsomListItemRequest=s,t.jsomEnsureUser=l,t.jsomGetItemsById=u,t.jsomGetFilesByRelativeUrl=c,t.jsomTaxonomyRequest=m,t.jsomSendDataToServer=d,r.d(t,"jsomCUD",function(){return _}),r.d(t,"jsomCreateItemsMetered",function(){return v}),r.d(t,"jsomUpdateItemsMetered",function(){return g}),r.d(t,"jsomRecycleItemsMetered",function(){return T});var p=r(1),f=(r.n(p),function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}()),h=function(e){var t,r=[];if(t=e.context?e.listItems:e,t.getEnumerator){for(var n=t.getEnumerator();n.moveNext();)r.push(n.get_current().get_fieldValues());return r}return t.forEach(function(e){r.push(e.get_fieldValues())}),r},y=function e(t){var r=null,n=t.allResults||[],o=Microsoft.SharePoint.Client;return r=o&&o.Search?Promise.resolve():Object(p.loadSPScript)("SP.Search.js"),r.then(function(){var e=t.url?new SP.ClientContext(t.url):new SP.ClientContext("/search"),r=new Microsoft.SharePoint.Client.Search.Query.KeywordQuery(e);if(t.startRow||(t.startRow=0),t.rowLimit||(t.rowLimit=250),r.set_queryText(t.query),r.set_sourceId(t.sourceId),r.set_trimDuplicates(t.trimDuplicates||!1),r.set_startRow(t.startRow),r.set_rowLimit(t.rowLimit),t.properties){var n=r.get_selectProperties();t.properties.forEach(function(e){n.add(e)})}return d({context:e,results:new Microsoft.SharePoint.Client.Search.Query.SearchExecutor(e).executeQuery(r)})}).then(function(r){var o=r.results.get_value(),a=o.ResultTables[0],i=a.ResultRows;return 0===i.length?t.allResults=[]:t.allResults=n.concat(i),a.TotalRows>t.startRow+a.RowCount?(t.startRow=t.startRow+a.RowCount,e(t)):t.allResults})};!function(){try{Object.assign,Promise}catch(e){throw new Error("The pd-spserverjsom library requires a polyfill for Object.assign and Promise. Please add both to continue.")}}();var _=function(){function e(){a(this,e),this.itemsToSend=[],this.userRequests=[],this._SP_Loaded=Object(p.waitForScriptsReady)("sp.js")}return f(e,[{key:"_getContext",value:function(e){return this.context=e?new this.sp.ClientContext(e):new this.sp.ClientContext.get_current,this}},{key:"_getList",value:function(e){var t=Object(p.validGuid)(e);return this.list=t?this.context.get_web().get_lists().getById(e):this.context.get_web().get_lists().getByTitle(e),this}},{key:"_dataTranmitter",value:function(){return d({context:this.context,listItems:this.itemsToSend})}},{key:"_addColumnData",value:function(e,t){var r=this;return t.forEach(function(t){if("taxBlank"===t.dataType){var n=r.list.get_fields().getByInternalNameOrTitle(t.columnName);r.context.castTo(n,r.sp.Taxonomy.TaxonomyField).validateSetValue(e,null)}else if("taxSingle"===t.dataType){var o=r.list.get_fields().getByInternalNameOrTitle(t.columnName),a=r.context.castTo(o,r.sp.Taxonomy.TaxonomyField),i=new r.sp.Taxonomy.TaxonomyFieldValue;i.set_label(t.termLabel),i.set_termGuid(t.termGuid),i.set_wssId(-1),a.setFieldValueByValue(e,i)}else if("taxMulti"===t.dataType){var s=r.list.get_fields().getByInternalNameOrTitle(t.columnName),l=r.context.castTo(s,r.sp.Taxonomy.TaxonomyField),u=t.multiTerms.map(function(e){return"-1;# "+e.termLabel+"|"+e.termGuid}),c=r.sp.Taxonomy.TaxonomyFieldValueCollection(u.join(";#"),l);l.setFieldValueByValueCollection(e,c)}else if("choiceMulti"===t.dataType)e.set_item(t.columnName,t.choices);else if("lookupSingle"===t.dataType){var m=new r.sp.FieldLookupValue;m.set_lookupId(t.itemId),e.set_item(t.columnName,m)}else if("lookupMulti"===t.dataType){var d=t.idArray.map(function(e){return r.sp.FieldUserValue.fromUser(e)});e.set_item(t.columnName,d)}else if("ppSingle"===t.dataType){var p=r.sp.FieldUserValue.fromUser(t.account);e.set_item(t.columnName,p)}else if("ppMulti"===t.dataType){var f=t.accountArray.map(function(e){return(new r.sp.FieldLookupValue).set_lookupId(e)});e.set_item(t.columnName,f)}else if("hyperlink"===t.dataType){var h=new r.sp.FieldUrlValue;h.set_url(t.url),h.set_description(t.description),e.set_item(t.columnName,h)}else"simple"===t.dataType&&e.set_item(t.columnName,t.columnValue)},this),this}},{key:"_loadItem",value:function(e){var t=this.itemsToSend.length;return e.update(),this.itemsToSend[t]=e,this.context.load(this.itemsToSend[t]),this}},{key:"_createListItems",value:function(){var e=this;return this.userRequests.forEach(function(t){var r=null;"create"===t.action?(r=e.list.addItem(new e.sp.ListItemCreationInformation),e._addColumnData(r,t.columnData)._loadItem(r)):"update"===t.action?(r=e.list.getItemById(t.itemId),e._addColumnData(r,t.columnData)._loadItem(r)):"recycle"===t.action?(r=e.list.getItemById(t.itemId),r.recycle()):"delete"===t.action&&(r=e.list.getItemById(t.itemId),r.deleteObject())},this),this}},{key:"_determineDataType",value:function(e){null===e.termGuid?e.dataType="taxBlank":e.termGuid?e.dataType="taxSingle":e.multiTerms?e.dataType="taxMulti":e.choices?e.dataType="choiceMulti":e.itemId?e.dataType="lookupSingle":e.idArray?e.dataType="lookupMulti":e.account?e.dataType="ppSingle":e.accountArray?e.dataType="ppMulti":e.url?e.dataType="hyperlink":e.dataType="simple"}},{key:"_addDataType",value:function(e){var t=this,r=[];return e.forEach(function(e){var n=Object.assign({},e);t._determineDataType(n),r.push(n)}),r}},{key:"_addItem",value:function(e,t,r){var n={};if(!e)throw new Error("action must be provided to add an object to addItem function");if(n.action=e.toLowerCase(),"create"!==e&&!r)throw new Error("a item id must be provided to update, delete or recycle an item");n.itemId=r,"create"!==e&&"update"!==e||(n.columnData=this._addDataType(t)),this.userRequests.push(n)}},{key:"createItem",value:function(e){this._addItem("create",e)}},{key:"updateItem",value:function(e,t){this._addItem("update",t,e)}},{key:"recycleItem",value:function(e){var t=this,r=Object(p.getDataType)(e);if("number"===r)this._addItem("recycle",null,e);else{if("array"!==r)throw new Error("invalid datatype passed to recycle item function");e.forEach(function(e){t._addItem("recycle",null,e)},this)}}},{key:"deleteItem",value:function(e){var t=this,r=Object(p.getDataType)(e);if("number"===r)this._addItem("delete",null,e);else{if("array"!==r)throw new Error("invalid datatype passed to delete item function");e.forEach(function(e){t._addItem("delete",null,e)},this)}}},{key:"totalRequests",value:function(){return this.userRequests.length}},{key:"sendToSever",value:function(e,t){var r=this;return this._SP_Loaded.then(function(){return r.sp=SP,r._getContext(e)._getList(t)._createListItems(),r._dataTranmitter()})}}]),e}(),I=function(e){function t(e){a(this,t);var r=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return r.notifier=new p.Sublish,r.processData=Object.assign({totalPerTrip:50,numberToStartAt:0,allItems:[],configured:!0},e),r}return o(t,e),f(t,[{key:"_loadData",value:function(){throw new Error("must impliment abtract loadData")}},{key:"_meterPrep",value:function(){this.userRequests.length>0&&(this.userRequests=[]),this.notifier.publish("preTrip",this.processData);var e=this.processData.numberToStartAt;for(e;e<this.processData.totalItems;e++){this._loadData(e);if(this.totalRequests()===this.processData.totalPerTrip||e===this.processData.totalItems){e++;break}}this.processData.numberToStartAt=e}},{key:"sendData",value:function(){var e=this;return this._meterPrep(),this.sendToSever(this.processData.url,this.processData.listGUID).then(function(t){var r=t.listItems;return e.processData.allItems=e.processData.allItems.concat(r),e.notifier.publish("postTrip",e.processData),e.processData.numberToStartAt<e.processData.totalItems?e.sendData():e.processData.allItems})}}]),t}(_),v=function(e){function t(e){a(this,t);var r=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.processData.totalItems=e.columnInfo.length,r}return o(t,e),f(t,[{key:"_loadData",value:function(e){this.createItem(this.processData.columnInfo[e])}}]),t}(I),g=function(e){function t(e){a(this,t);var r=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.processData.totalItems=e.updateInfo.length,r}return o(t,e),f(t,[{key:"_loadData",value:function(e){var t=this.processData.updateInfo[e];this.updateItem(t.itemId,t.columnInfo)}}]),t}(I),T=function(e){function t(e){a(this,t);var r=n(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return r.processData.totalItems=e.recycleIds.length,r}return o(t,e),f(t,[{key:"_loadData",value:function(e){this.recycleItem(this.processData.recycleIds[e])}}]),t}(I)},function(t,r){t.exports=e}])});